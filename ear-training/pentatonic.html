<!doctype html>
<html lang="en">
  <head>
    <!-- Google tag (gtag.js) -->
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-RLY5G4FXNC"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());
      gtag("config", "G-RLY5G4FXNC");
    </script>

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pentatonic - Ear Training - Banjo Sandwich</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="stylesheet" href="/styles.css" />

    <script src="https://unpkg.com/tone"></script>
    <script src="/js/analytics.js"></script>

    <script src="/js/ear-training.js" defer></script>

    <script>
      // Enhanced playNote function with fretboard tracking and capo support
      function playNoteFromFretboard(baseNote, string, fret) {
        // Calculate the actual note with capo (use fretboard-specific capo position)
        const actualCapoPosition = fretboardCapoPosition;
        const actualNote = transposeNoteForCapo(baseNote, actualCapoPosition);

        // Use fretboard-specific instrument
        playNoteWithInstrument(actualNote, fretboardInstrument);

        // Track fretboard interactions
        if (typeof gtag !== "undefined") {
          gtag("event", "fretboard_note_play", {
            event_category: "ear_training",
            event_label: actualNote,
            base_note: baseNote,
            capo_position: actualCapoPosition,
            string: string,
            fret_position: fret,
            instrument: fretboardInstrument,
            custom_parameter_1: "fretboard_interaction",
          });
        }
      }

      // Separate instrument settings for fretboard
      let fretboardInstrument = "synth";
      let fretboardCapoPosition = 0;

      // Function to play note with specific instrument
      function playNoteWithInstrument(note, instrument) {
        if (instrument === "banjo") {
          if (typeof banjoSampler !== "undefined" && banjoSampler.loaded) {
            banjoSampler.triggerAttackRelease(note, "2n.");
          } else {
            console.warn("Banjo sampler not loaded, falling back to synth");
            if (typeof synthInstrument !== "undefined") {
              synthInstrument.triggerAttackRelease(note, "1n");
            }
          }
        } else {
          // Default to synth
          if (typeof synthInstrument !== "undefined") {
            synthInstrument.triggerAttackRelease(note, "1n");
          }
        }
      }

      // Function to set fretboard instrument
      function setFretboardInstrument(instrument) {
        fretboardInstrument = instrument;

        // Track instrument change for fretboard
        if (typeof gtag !== "undefined") {
          gtag("event", "fretboard_instrument_change", {
            event_category: "ear_training",
            event_label: instrument,
            custom_parameter_1: "fretboard_instrument_selection",
          });
        }
      }

      // Function to set fretboard capo position
      function setFretboardCapoPosition(fretNumber) {
        fretboardCapoPosition = fretNumber;
        updateFretboardDisplay();

        // Track capo changes for fretboard
        if (typeof gtag !== "undefined") {
          gtag("event", "fretboard_capo_change", {
            event_category: "ear_training",
            event_label: `capo_fret_${fretNumber}`,
            value: fretNumber,
            custom_parameter_1: "fretboard_capo_position",
          });
        }
      }

      // Function to transpose a note based on capo position
      function transposeNoteForCapo(note, capoFrets) {
        if (capoFrets === 0) return note;

        // Extract note name and octave
        const noteRegex = /([A-G][#b]?)([0-9]+)/;
        const match = note.match(noteRegex);
        if (!match) return note;

        const noteName = match[1];
        const octave = parseInt(match[2]);

        // Chromatic scale
        const chromaticScale = [
          "C",
          "C#",
          "D",
          "D#",
          "E",
          "F",
          "F#",
          "G",
          "G#",
          "A",
          "A#",
          "B",
        ];

        // Find current note index
        let noteIndex = chromaticScale.indexOf(noteName);
        if (noteIndex === -1) {
          // Handle flat notes
          const flatToSharp = {
            Db: "C#",
            Eb: "D#",
            Gb: "F#",
            Ab: "G#",
            Bb: "A#",
          };
          noteIndex = chromaticScale.indexOf(flatToSharp[noteName] || noteName);
        }

        if (noteIndex === -1) return note; // Fallback

        // Calculate new note index
        const newNoteIndex = (noteIndex + capoFrets) % 12;
        let newOctave = octave;

        // Check if we've crossed into the next octave
        if (noteIndex + capoFrets >= 12) {
          newOctave += Math.floor((noteIndex + capoFrets) / 12);
        }

        return chromaticScale[newNoteIndex] + newOctave;
      }

      // Function to set capo position (for backward compatibility)
      function setCapoPosition(fretNumber) {
        // This function exists for backward compatibility but now only affects main ear training
        // Update both local and global capo position for main ear training
        if (typeof currentCapoPosition !== "undefined") {
          currentCapoPosition = fretNumber;
        }

        // Update the main capo selector if called from elsewhere
        const selector = document.getElementById("capo-selector");
        if (selector && selector.value != fretNumber) {
          selector.value = fretNumber;
        }

        // Call the main setCapoPosition function if it exists
        if (
          typeof window.setCapoPosition !== setCapoPosition &&
          typeof window.setCapoPosition === "function"
        ) {
          window.setCapoPosition(fretNumber);
        }

        // Track capo changes for main ear training
        if (typeof gtag !== "undefined") {
          gtag("event", "capo_change", {
            event_category: "ear_training",
            event_label: `capo_fret_${fretNumber}`,
            value: fretNumber,
            custom_parameter_1: "capo_position",
          });
        }
      }

      // Function to update fretboard display with fretboard-specific capo information
      function updateFretboardDisplay() {
        const actualCapoPosition = fretboardCapoPosition;
        const noteButtons = document.querySelectorAll(
          ".banjo-fretboard .note-btn",
        );

        noteButtons.forEach((button) => {
          // Get the original note from data attribute
          const baseNote = button.getAttribute("data-original-note");

          if (baseNote) {
            // Calculate new note with capo
            const newNote = transposeNoteForCapo(baseNote, actualCapoPosition);

            // Update button display
            if (actualCapoPosition > 0) {
              button.innerHTML = `${newNote}<br><small>(+${actualCapoPosition})</small>`;
              button.classList.add("capo-active");
            } else {
              button.textContent = baseNote;
              button.classList.remove("capo-active");
            }
          }
        });

        // Update fret numbers to account for capo
        const fretNumbers = document.querySelectorAll(".fret-number");
        fretNumbers.forEach((fretSpan, index) => {
          if (index === 0) return; // Skip the empty first span

          if (index === 1) {
            // Nut position
            if (actualCapoPosition > 0) {
              fretSpan.textContent = `Capo`;
            } else {
              fretSpan.textContent = "Open";
            }
          } else {
            // Numbered frets
            const originalFret = index - 1; // Convert index to fret number
            if (actualCapoPosition > 0) {
              const adjustedFret = originalFret + actualCapoPosition;
              fretSpan.textContent = adjustedFret.toString();
            } else {
              fretSpan.textContent = originalFret.toString();
            }
          }
        });

        // Update fretboard header to show capo position
        const fretboardContainer = document.querySelector(
          ".fretboard-container h4",
        );
        if (fretboardContainer) {
          if (actualCapoPosition > 0) {
            fretboardContainer.textContent = `Pentatonic Scale on Banjo Fretboard (Capo ${actualCapoPosition})`;
          } else {
            fretboardContainer.textContent =
              "Pentatonic Scale on Banjo Fretboard";
          }
        }
      }

      // Initialize fretboard display on page load
      document.addEventListener("DOMContentLoaded", function () {
        // Small delay to ensure elements are rendered
        setTimeout(() => {
          updateFretboardDisplay();
          updateFretboardScaleDisplay();
        }, 100);

        // Setup instructions details element
        const instructionsDetails = document.getElementById(
          "instructions-details",
        );
        if (instructionsDetails) {
          // Check URL parameter for initial state
          const urlParams = new URLSearchParams(window.location.search);
          const instructionsParam = urlParams.get("instructions");
          if (instructionsParam === "false") {
            instructionsDetails.removeAttribute("open");
          }

          // Add event listener for toggle tracking
          instructionsDetails.addEventListener("toggle", function () {
            handleInstructionsToggle(this.open);
          });
        }
      });

      // Update URL parameter when instructions toggle changes
      function updateInstructionsURLParameter(isOpen) {
        const url = new URL(window.location);
        if (isOpen) {
          url.searchParams.delete("instructions"); // Remove param when showing (default state)
        } else {
          url.searchParams.set("instructions", "false");
        }
        window.history.replaceState(null, "", url);
      }

      // Handle instructions toggle
      function handleInstructionsToggle(isOpen) {
        // Update URL parameter
        updateInstructionsURLParameter(isOpen);

        // Save to local storage if the function is available
        if (typeof setInstructionsDisplay === "function") {
          setInstructionsDisplay(isOpen);
        }

        // Track toggle usage
        if (typeof gtag !== "undefined") {
          gtag("event", "instructions_toggle", {
            event_category: "ear_training",
            event_label: isOpen ? "shown" : "hidden",
            custom_parameter_1: "instructions_visibility",
          });
        }
      }
    </script>
  </head>
  <body class="ear-training-page">
    <div id="header-placeholder"></div>
    <script src="/js/header.js"></script>

    <main>
      <section class="hero">
        <div class="container">
          <div class="hero-content">
            <h2>Ear Training</h2>
            <p>Develop your musical ear for banjo and bluegrass</p>
          </div>
        </div>
      </section>

      <section class="events-section">
        <div class="container">
          <details
            class="pentatonic-training-container"
            id="instructions-details"
          >
            <summary>Instructions</summary>
            <div class="test-description">
              <p>
                This ear training exercise helps you develop the ability to
                identify notes within the G major scale patterns commonly used
                in banjo playing. Choose between the traditional pentatonic
                scale (fundamental to bluegrass) or the full G major scale for
                more comprehensive training.
              </p>

              <p class="note-explanation">
                <strong>Note:</strong> The pentatonic mode includes C4 even
                though it's not part of the G major pentatonic scale (G, A, B,
                D, E). This note commonly appears as a passing tone in bluegrass
                banjo playing and sits naturally on the 1st fret of the B string
                in the standard pentatonic box pattern.
              </p>

              <h4>How to Use This Test:</h4>
              <ul>
                <li>
                  <strong>Click "Play Note"</strong> to hear a random note from
                  the pentatonic box
                </li>
                <li>
                  <strong>Listen carefully</strong> and try to identify which
                  note was played
                </li>
                <li>
                  <strong>Click your guess</strong> from the available note
                  buttons
                </li>
                <li>
                  <strong>Get immediate feedback</strong> - green for correct,
                  red for incorrect
                </li>
                <li>
                  <strong>Track your progress</strong> with the accuracy
                  percentage displayed
                </li>
              </ul>

              <h4>Practice Tips:</h4>
              <ul>
                <li>
                  Start by familiarizing yourself with the sound of each note
                  individually
                </li>
                <li>
                  Pay attention to the relative pitch relationships between
                  notes
                </li>
                <li>
                  Practice regularly in short sessions to build your ear
                  gradually
                </li>
                <li>
                  Use this alongside physical practice on your banjo for best
                  results
                </li>
                <li>
                  <strong>Don't have a banjo with you just now?</strong> Mix
                  instruments for practice: set the fretboard to "banjo" and the
                  test to "synth" to hear realistic banjo tones while testing
                  with clean synthetic notes, or vice versa to challenge your
                  ear with different timbres
                </li>
              </ul>

              <h4>Scale Mode: Pentatonic vs Full G Major</h4>
              <p>
                Choose between two scale modes to customize your ear training:
              </p>
              <ul>
                <li>
                  <strong>Pentatonic Scale:</strong> The traditional G major
                  pentatonic (G, A, B, D, E) plus C as a passing tone. This
                  6-note scale is fundamental to bluegrass banjo and creates a
                  distinctive, open sound.
                </li>
                <li>
                  <strong>Full G Major Scale:</strong> The complete 7-note major
                  scale (G, A, B, C, D, E, F#). This includes all the pentatonic
                  notes plus F# (the leading tone), providing more harmonic
                  complexity and resolution.
                </li>
              </ul>
              <p>
                <strong>Key Differences:</strong>
              </p>
              <ul>
                <li>
                  <strong>Pentatonic</strong> avoids half-steps, creating a more
                  "safe" and traditional bluegrass sound
                </li>
                <li>
                  <strong>Full Major Scale</strong> includes the F# leading
                  tone, which creates stronger resolution to G and more
                  classical harmonic movement
                </li>
                <li>
                  F# adds tension and "pull" toward the root note G, making
                  melodies more directional
                </li>
              </ul>

              <h4>Reference Note Feature</h4>
              <p>
                When enabled, each test will automatically play the root note
                (G) first, followed by the test note. This helps develop
                <strong>relative pitch</strong> skills by giving you a reference
                point within the key.
              </p>
              <ul>
                <li>
                  <strong>With Reference Note:</strong> Tests relative pitch -
                  your ability to identify scale degrees and intervals within a
                  musical context
                </li>
                <li>
                  <strong>Without Reference Note:</strong> Tests absolute pitch
                  - your ability to identify specific pitches without a
                  reference
                </li>
              </ul>
              <p>
                <em>Tip:</em> Start with the reference note enabled to learn the
                relationships between notes, then try disabling it to challenge
                your absolute pitch recognition.
              </p>
            </div>
          </details>

          <div class="instrument-selection">
            <div class="control-group">
              <label for="scale-mode-selector">Scale Mode:</label>
              <select
                id="scale-mode-selector"
                onchange="setScaleMode(this.value)"
                title="Choose between pentatonic (6 notes) or full major scale (7 notes)"
              >
                <option value="pentatonic" selected>
                  Pentatonic Scale (G, A, B, C, D, E)
                </option>
                <option value="full-major">Full G Major Scale (+ F#)</option>
              </select>
            </div>

            <div class="control-group">
              <label for="instrument-selector">Instrument:</label>
              <select
                id="instrument-selector"
                onchange="setInstrument(this.value)"
              >
                <option value="banjo">Sebastian's Banjo</option>
                <option value="synth" selected>Synth</option>
              </select>
            </div>

            <div class="control-group">
              <label for="capo-selector">Capo:</label>
              <select
                id="capo-selector"
                onchange="setCapoPosition(parseInt(this.value))"
              >
                <option value="0" selected>No Capo</option>
                <option value="1">1st Fret</option>
                <option value="2">2nd Fret</option>
                <option value="3">3rd Fret</option>
                <option value="4">4th Fret</option>
                <option value="5">5th Fret</option>
              </select>
            </div>

            <div class="control-group">
              <label for="reference-note-toggle">Reference Note:</label>
              <input
                type="checkbox"
                id="reference-note-toggle"
                checked
                onchange="toggleReferenceNote(this.checked)"
                title="Play a reference note (root of the scale) before each test note"
              />
              <label for="reference-note-toggle" class="checkbox-label"
                >Enable</label
              >
            </div>

            <div class="control-group">
              <label>Progress:</label>
              <div class="progress-controls">
                <button
                  onclick="startFreshSession()"
                  title="Start a fresh set of tests (clears saved progress)"
                  class="action-button fresh-button"
                >
                  Fresh Tests
                </button>
                <span
                  id="saved-progress-indicator"
                  class="progress-indicator"
                ></span>
              </div>
            </div>
          </div>

          <div class="overall-totals">
            <span id="overall-totals"
              >Total Correct: 0 | Total Incorrect: 0</span
            >
          </div>

          <div id="tests-container" class="tests-container">
            <!-- Tests will be generated here -->
          </div>

          <div class="fretboard-container">
            <h4>Pentatonic Scale on Banjo Fretboard</h4>

            <!-- Separate instrument control for fretboard -->
            <div class="fretboard-instrument-selection">
              <div class="control-group">
                <label for="fretboard-instrument-selector"
                  >Fretboard Sound:</label
                >
                <select
                  id="fretboard-instrument-selector"
                  onchange="setFretboardInstrument(this.value)"
                >
                  <option value="banjo">Sebastian's Banjo</option>
                  <option value="synth" selected>Synth</option>
                </select>
              </div>

              <div class="control-group">
                <label for="fretboard-capo-selector">Capo:</label>
                <select
                  id="fretboard-capo-selector"
                  onchange="setFretboardCapoPosition(parseInt(this.value))"
                >
                  <option value="0" selected>No Capo</option>
                  <option value="1">1st Fret</option>
                  <option value="2">2nd Fret</option>
                  <option value="3">3rd Fret</option>
                  <option value="4">4th Fret</option>
                  <option value="5">5th Fret</option>
                </select>
              </div>
            </div>

            <div class="banjo-fretboard">
              <!-- Fret numbers -->
              <div class="fret-numbers">
                <span class="fret-number"></span>
                <span class="fret-number">Open</span>
                <span class="fret-number">1</span>
                <span class="fret-number">2</span>
                <span class="fret-number">3</span>
                <span class="fret-number">4</span>
                <span class="fret-number">5</span>
              </div>

              <!-- String 1 (D) -->
              <div class="string-row">
                <span class="string-label">D</span>
                <div class="fret pentatonic">
                  <button
                    class="note-btn"
                    data-original-note="D4"
                    onclick="playNoteFromFretboard('D4', 'D', 0)"
                  >
                    D4
                  </button>
                </div>
                <div class="fret"></div>
                <div class="fret pentatonic">
                  <button
                    class="note-btn"
                    data-original-note="E4"
                    onclick="playNoteFromFretboard('E4', 'D', 2)"
                  >
                    E4
                  </button>
                </div>
                <div class="fret"></div>
                <div class="fret full-major hidden">
                  <button
                    class="note-btn"
                    data-original-note="F#4"
                    onclick="playNoteFromFretboard('F#4', 'D', 4)"
                  >
                    F#4
                  </button>
                </div>
                <div class="fret"></div>
              </div>

              <!-- String 2 (B) -->
              <div class="string-row">
                <span class="string-label">B</span>
                <div class="fret pentatonic">
                  <button
                    class="note-btn"
                    data-original-note="B3"
                    onclick="playNoteFromFretboard('B3', 'B', 0)"
                  >
                    B3
                  </button>
                </div>
                <div class="fret passing">
                  <button
                    class="note-btn"
                    data-original-note="C4"
                    onclick="playNoteFromFretboard('C4', 'B', 1)"
                  >
                    C4
                  </button>
                </div>
                <div class="fret"></div>
                <div class="fret"></div>
                <div class="fret"></div>
                <div class="fret"></div>
              </div>

              <!-- String 3 (G) -->
              <div class="string-row">
                <span class="string-label">G</span>
                <div class="fret pentatonic">
                  <button
                    class="note-btn"
                    data-original-note="G3"
                    onclick="playNoteFromFretboard('G3', 'G', 0)"
                  >
                    G3
                  </button>
                </div>
                <div class="fret"></div>
                <div class="fret pentatonic">
                  <button
                    class="note-btn"
                    data-original-note="A3"
                    onclick="playNoteFromFretboard('A3', 'G', 2)"
                  >
                    A3
                  </button>
                </div>
                <div class="fret"></div>
                <div class="fret"></div>
                <div class="fret"></div>
              </div>

              <!-- String 4 (D) -->
              <div class="string-row">
                <span class="string-label">D</span>
                <div class="fret pentatonic">
                  <button
                    class="note-btn"
                    data-original-note="D3"
                    onclick="playNoteFromFretboard('D3', 'D-low', 0)"
                  >
                    D3
                  </button>
                </div>
                <div class="fret"></div>
                <div class="fret pentatonic">
                  <button
                    class="note-btn"
                    data-original-note="E3"
                    onclick="playNoteFromFretboard('E3', 'D-low', 2)"
                  >
                    E3
                  </button>
                </div>
                <div class="fret"></div>
                <div class="fret full-major hidden">
                  <button
                    class="note-btn"
                    data-original-note="F#3"
                    onclick="playNoteFromFretboard('F#3', 'D-low', 4)"
                  >
                    F#3
                  </button>
                </div>
                <div class="fret"></div>
              </div>

              <!-- String 5 (G) - 5th string (shorter) -->
              <div class="string-row fifth-string">
                <span class="string-label">g</span>
                <div class="fret empty"></div>
                <div class="fret empty"></div>
                <div class="fret empty"></div>
                <div class="fret empty"></div>
                <div class="fret empty"></div>
                <div class="fret">
                  <button
                    class="note-btn"
                    data-original-note="G4"
                    onclick="playNoteFromFretboard('G4', 'g', 5)"
                  >
                    G4
                  </button>
                </div>
              </div>

              <div class="legend">
                <span class="legend-item">
                  <span class="legend-dot pentatonic"></span>
                  Pentatonic Scale Notes
                </span>
                <span class="legend-item">
                  <span class="legend-dot passing"></span>
                  Passing Tone (C)
                </span>
                <span class="legend-item full-major-legend hidden">
                  <span class="legend-dot full-major"></span>
                  Leading Tone (F#)
                </span>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <div id="footer-placeholder"></div>
    <script src="/js/footer.js"></script>
  </body>
</html>
