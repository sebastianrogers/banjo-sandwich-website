<!doctype html>
<html lang="en">
  <head>
    <!-- Google tag (gtag.js) -->
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-RLY5G4FXNC"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());
      gtag("config", "G-RLY5G4FXNC");
    </script>

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ear Training - Banjo Sandwich</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="stylesheet" href="/styles.css" />

    <script src="https://unpkg.com/tone"></script>
    <script src="/js/analytics.js"></script>

    <script src="/js/ear-training.js" defer></script>

    <script>
      // Enhanced playNote function with fretboard tracking and capo support
      function playNoteFromFretboard(baseNote, string, fret) {
        // Calculate the actual note with capo (use currentCapoPosition from ear-training.js)
        const actualCapoPosition =
          typeof currentCapoPosition !== "undefined" ? currentCapoPosition : 0;
        const actualNote = transposeNoteForCapo(baseNote, actualCapoPosition);
        playNote(actualNote);

        // Track fretboard interactions
        if (typeof gtag !== "undefined") {
          gtag("event", "fretboard_note_play", {
            event_category: "ear_training",
            event_label: actualNote,
            base_note: baseNote,
            capo_position: actualCapoPosition,
            string: string,
            fret_position: fret,
            instrument: currentInstrument || "synth", // Default to synth if not set yet
            custom_parameter_1: "fretboard_interaction",
          });
        }
      }

      // Function to transpose a note based on capo position
      function transposeNoteForCapo(note, capoFrets) {
        if (capoFrets === 0) return note;

        // Extract note name and octave
        const noteRegex = /([A-G][#b]?)([0-9]+)/;
        const match = note.match(noteRegex);
        if (!match) return note;

        const noteName = match[1];
        const octave = parseInt(match[2]);

        // Chromatic scale
        const chromaticScale = [
          "C",
          "C#",
          "D",
          "D#",
          "E",
          "F",
          "F#",
          "G",
          "G#",
          "A",
          "A#",
          "B",
        ];

        // Find current note index
        let noteIndex = chromaticScale.indexOf(noteName);
        if (noteIndex === -1) {
          // Handle flat notes
          const flatToSharp = {
            Db: "C#",
            Eb: "D#",
            Gb: "F#",
            Ab: "G#",
            Bb: "A#",
          };
          noteIndex = chromaticScale.indexOf(flatToSharp[noteName] || noteName);
        }

        if (noteIndex === -1) return note; // Fallback

        // Calculate new note index
        const newNoteIndex = (noteIndex + capoFrets) % 12;
        let newOctave = octave;

        // Check if we've crossed into the next octave
        if (noteIndex + capoFrets >= 12) {
          newOctave += Math.floor((noteIndex + capoFrets) / 12);
        }

        return chromaticScale[newNoteIndex] + newOctave;
      }

      // Function to set capo position
      function setCapoPosition(fretNumber) {
        // Update both local and global capo position
        if (typeof currentCapoPosition !== "undefined") {
          currentCapoPosition = fretNumber;
        }

        updateFretboardDisplay();

        // Update the capo selector if called from elsewhere
        const selector = document.getElementById("capo-selector");
        if (selector && selector.value != fretNumber) {
          selector.value = fretNumber;
        }

        // Call the main setCapoPosition function if it exists
        if (
          typeof window.setCapoPosition !== setCapoPosition &&
          typeof window.setCapoPosition === "function"
        ) {
          window.setCapoPosition(fretNumber);
        }

        // Track capo changes
        if (typeof gtag !== "undefined") {
          gtag("event", "capo_change", {
            event_category: "ear_training",
            event_label: `capo_fret_${fretNumber}`,
            value: fretNumber,
            custom_parameter_1: "capo_position",
          });
        }
      }

      // Function to update fretboard display with capo information
      function updateFretboardDisplay() {
        const actualCapoPosition =
          typeof currentCapoPosition !== "undefined" ? currentCapoPosition : 0;
        const noteButtons = document.querySelectorAll(
          ".banjo-fretboard .note-btn",
        );

        noteButtons.forEach((button) => {
          // Get the original note from data attribute
          const baseNote = button.getAttribute("data-original-note");

          if (baseNote) {
            // Calculate new note with capo
            const newNote = transposeNoteForCapo(baseNote, actualCapoPosition);

            // Update button display
            if (actualCapoPosition > 0) {
              button.innerHTML = `${newNote}<br><small>(+${actualCapoPosition})</small>`;
              button.classList.add("capo-active");
            } else {
              button.textContent = baseNote;
              button.classList.remove("capo-active");
            }
          }
        });

        // Update fret numbers to account for capo
        const fretNumbers = document.querySelectorAll(".fret-number");
        fretNumbers.forEach((fretSpan, index) => {
          if (index === 0) return; // Skip the empty first span

          if (index === 1) {
            // Nut position
            if (actualCapoPosition > 0) {
              fretSpan.textContent = `Capo`;
            } else {
              fretSpan.textContent = "Nut";
            }
          } else {
            // Numbered frets
            const originalFret = index - 1; // Convert index to fret number
            if (actualCapoPosition > 0) {
              const adjustedFret = originalFret + actualCapoPosition;
              fretSpan.textContent = adjustedFret.toString();
            } else {
              fretSpan.textContent = originalFret.toString();
            }
          }
        });

        // Update fretboard header to show capo position
        const fretboardContainer = document.querySelector(
          ".fretboard-container h4",
        );
        if (fretboardContainer) {
          if (actualCapoPosition > 0) {
            fretboardContainer.textContent = `Pentatonic Scale on Banjo Fretboard (Capo ${actualCapoPosition})`;
          } else {
            fretboardContainer.textContent =
              "Pentatonic Scale on Banjo Fretboard";
          }
        }
      }

      // Initialize fretboard display on page load
      document.addEventListener("DOMContentLoaded", function () {
        // Small delay to ensure elements are rendered
        setTimeout(updateFretboardDisplay, 100);
      });
    </script>
  </head>
  <body class="ear-training-page">
    <div id="header-placeholder"></div>
    <script src="/js/header.js"></script>

    <main>
      <section class="hero">
        <div class="container">
          <div class="hero-content">
            <h2>Ear Training</h2>
            <p>Develop your musical ear for banjo and bluegrass</p>
          </div>
        </div>
      </section>

      <section class="events-section">
        <div class="container">
          <h2>Pentatonic Box Notes</h2>

          <div class="pentatonic-training-container">
            <div class="test-description">
              <p>
                This test helps you develop the ability to identify notes within
                the pentatonic scale box pattern commonly used in banjo playing.
                The pentatonic scale is fundamental to bluegrass and country
                music, making it essential for banjo players to recognize these
                notes by ear.
              </p>

              <p class="note-explanation">
                <strong>Note:</strong> C4 is included in this exercise even
                though it's not part of the G major pentatonic scale (G, A, B,
                D, E). This note is commonly used as a passing tone in bluegrass
                banjo playing and appears naturally on the 1st fret of the B
                string in the standard pentatonic box pattern, making it
                important for practical ear training.
              </p>

              <h4>How to Use This Test:</h4>
              <ul>
                <li>
                  <strong>Click "Play Note"</strong> to hear a random note from
                  the pentatonic box
                </li>
                <li>
                  <strong>Listen carefully</strong> and try to identify which
                  note was played
                </li>
                <li>
                  <strong>Click your guess</strong> from the available note
                  buttons
                </li>
                <li>
                  <strong>Get immediate feedback</strong> - green for correct,
                  red for incorrect
                </li>
                <li>
                  <strong>Track your progress</strong> with the accuracy
                  percentage displayed
                </li>
              </ul>

              <h4>Practice Tips:</h4>
              <ul>
                <li>
                  Start by familiarizing yourself with the sound of each note
                  individually
                </li>
                <li>
                  Pay attention to the relative pitch relationships between
                  notes
                </li>
                <li>
                  Practice regularly in short sessions to build your ear
                  gradually
                </li>
                <li>
                  Use this alongside physical practice on your banjo for best
                  results
                </li>
              </ul>
            </div>

            <div class="fretboard-container">
              <h4>Pentatonic Scale on Banjo Fretboard</h4>
              <div class="banjo-fretboard">
                <!-- Fret numbers -->
                <div class="fret-numbers">
                  <span class="fret-number"></span>
                  <span class="fret-number">Nut</span>
                  <span class="fret-number">1</span>
                  <span class="fret-number">2</span>
                  <span class="fret-number">3</span>
                  <span class="fret-number">4</span>
                  <span class="fret-number">5</span>
                </div>

                <!-- String 1 (D) -->
                <div class="string-row">
                  <span class="string-label">D</span>
                  <div class="fret pentatonic">
                    <button
                      class="note-btn"
                      data-original-note="D4"
                      onclick="playNoteFromFretboard('D4', 'D', 0)"
                    >
                      D4
                    </button>
                  </div>
                  <div class="fret"></div>
                  <div class="fret pentatonic">
                    <button
                      class="note-btn"
                      data-original-note="E4"
                      onclick="playNoteFromFretboard('E4', 'D', 2)"
                    >
                      E4
                    </button>
                  </div>
                  <div class="fret"></div>
                  <div class="fret"></div>
                  <div class="fret"></div>
                </div>

                <!-- String 2 (B) -->
                <div class="string-row">
                  <span class="string-label">B</span>
                  <div class="fret pentatonic">
                    <button
                      class="note-btn"
                      data-original-note="B3"
                      onclick="playNoteFromFretboard('B3', 'B', 0)"
                    >
                      B3
                    </button>
                  </div>
                  <div class="fret passing">
                    <button
                      class="note-btn"
                      data-original-note="C4"
                      onclick="playNoteFromFretboard('C4', 'B', 1)"
                    >
                      C4
                    </button>
                  </div>
                  <div class="fret"></div>
                  <div class="fret"></div>
                  <div class="fret"></div>
                  <div class="fret"></div>
                </div>

                <!-- String 3 (G) -->
                <div class="string-row">
                  <span class="string-label">G</span>
                  <div class="fret pentatonic">
                    <button
                      class="note-btn"
                      data-original-note="G3"
                      onclick="playNoteFromFretboard('G3', 'G', 0)"
                    >
                      G3
                    </button>
                  </div>
                  <div class="fret"></div>
                  <div class="fret pentatonic">
                    <button
                      class="note-btn"
                      data-original-note="A3"
                      onclick="playNoteFromFretboard('A3', 'G', 2)"
                    >
                      A3
                    </button>
                  </div>
                  <div class="fret"></div>
                  <div class="fret"></div>
                  <div class="fret"></div>
                </div>

                <!-- String 4 (D) -->
                <div class="string-row">
                  <span class="string-label">D</span>
                  <div class="fret pentatonic">
                    <button
                      class="note-btn"
                      data-original-note="D3"
                      onclick="playNoteFromFretboard('D3', 'D-low', 0)"
                    >
                      D3
                    </button>
                  </div>
                  <div class="fret"></div>
                  <div class="fret pentatonic">
                    <button
                      class="note-btn"
                      data-original-note="E3"
                      onclick="playNoteFromFretboard('E3', 'D-low', 2)"
                    >
                      E3
                    </button>
                  </div>
                  <div class="fret"></div>
                  <div class="fret"></div>
                  <div class="fret"></div>
                </div>

                <!-- String 5 (G) - 5th string (shorter) -->
                <div class="string-row fifth-string">
                  <span class="string-label">g</span>
                  <div class="fret empty"></div>
                  <div class="fret empty"></div>
                  <div class="fret empty"></div>
                  <div class="fret empty"></div>
                  <div class="fret empty"></div>
                  <div class="fret">
                    <button
                      class="note-btn"
                      data-original-note="G4"
                      onclick="playNoteFromFretboard('G4', 'g', 5)"
                    >
                      G4
                    </button>
                  </div>
                </div>

                <div class="legend">
                  <span class="legend-item">
                    <span class="legend-dot pentatonic"></span>
                    Pentatonic Scale Notes
                  </span>
                  <span class="legend-item">
                    <span class="legend-dot passing"></span>
                    Passing Tone
                  </span>
                </div>
              </div>
            </div>
          </div>

          <div class="instrument-selection">
            <div class="control-group">
              <label for="instrument-selector">Instrument:</label>
              <select
                id="instrument-selector"
                onchange="setInstrument(this.value)"
              >
                <option value="banjo">Sebastian's Banjo</option>
                <option value="synth" selected>Synth</option>
              </select>
            </div>

            <div class="control-group">
              <label for="capo-selector">Capo:</label>
              <select
                id="capo-selector"
                onchange="setCapoPosition(parseInt(this.value))"
              >
                <option value="0" selected>No Capo</option>
                <option value="1">1st Fret</option>
                <option value="2">2nd Fret</option>
                <option value="3">3rd Fret</option>
                <option value="4">4th Fret</option>
                <option value="5">5th Fret</option>
              </select>
            </div>
          </div>

          <div class="overall-totals">
            <span id="overall-totals"
              >Total Correct: 0 | Total Incorrect: 0</span
            >
          </div>

          <div id="tests-container" class="tests-container">
            <!-- Tests will be generated here -->
          </div>
        </div>
      </section>
    </main>

    <div id="footer-placeholder"></div>
    <script src="js/footer.js"></script>
  </body>
</html>
